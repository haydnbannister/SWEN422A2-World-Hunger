<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link href="nv.d3.css" rel="stylesheet" type="text/css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.min.js" charset="utf-8"></script>
    <script src="nv.d3.js"></script>

    <style>
        text {
            font: 12px sans-serif;
        }
        svg {
            display: block;
        }
        html, body, svg {
            margin: 0px;
            padding: 0px;
            height: 90%;
            width: 100%;
        }


        .category-button {
            background-color: steelblue;
            border: none;
            color: white;
            padding: 12px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 20px;
            margin-top: 10px;
        }
        .category-button-clicked {
            background-color: green;
            border: none;
            color: white;
            padding: 12px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 20px;
            margin-top: 10px;
        }

        .mode-button {
            background-color: steelblue;
            border: none;
            color: white;
            padding: 12px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 15px;
            margin-top: 10px;
        }
        .mode-button-clicked {
            background-color: green;
            border: none;
            color: white;
            padding: 12px 32px;
            text-align: center;
            text-decoration: none;
            display: inline-block;
            font-size: 15px;
            margin-top: 10px;
        }

        .control-group {
            margin-left: 60px;
            margin-bottom: 10px;
        }

    </style>
</head>

<body class='with-3d-shadow with-transitions'>

<div class="control-group">
    <button class="mode-button" onclick="modeChange('millions'); modeButton(this)">
        Millions
    </button>
    <button class="mode-button" onclick="modeChange('percent'); modeButton(this)">
        Percentage
    </button>
</div>

<svg id="chart1"></svg>

<div class="control-group">
    <button class="category-button" onclick="filterChange('continent'); highlightButton(this)">
        Continents
    </button>
    <button class="category-button" onclick="filterChange('all'); highlightButton(this)">
        All Countries
    </button>
</div>

<div class="control-group">
    <button class="category-button" onclick="filterChange('AF'); highlightButton(this)">
        African Countries
    </button>
    <button class="category-button" onclick="filterChange('EU'); highlightButton(this)">
        European Countries
    </button>
    <button class="category-button" onclick="filterChange('SA'); highlightButton(this)">
        South American Countries
    </button>
    <button class="category-button" onclick="filterChange('AS'); highlightButton(this)">
        Asian Countries
    </button>
    <button class="category-button" onclick="filterChange('NA'); highlightButton(this)">
        North American Countries
    </button>
</div>

<script>
    var clickedBuffer=null;
    function highlightButton(obj){
        if (clickedBuffer === null) {
            obj.className=' category-button-clicked ';
        }
        else{
            /* note the class name contains a black character  before and after the word !! */
            clickedBuffer.className = ' category-button ';
            obj.className= obj.className + ' category-button-clicked ';
        }
        clickedBuffer=obj;
        return false; /* ONLY if you want the  button not to lead to another HTML doc*/
    }

    var modeBuffer=null;
    function modeButton(obj){
        if (modeBuffer === null) {
            obj.className=' mode-button-clicked ';
        }
        else{
            /* note the class name contains a black character  before and after the word !! */
            modeBuffer.className = ' mode-button ';
            obj.className= obj.className + ' mode-button-clicked ';
        }
        modeBuffer=obj;
        return false; /* ONLY if you want the  button not to lead to another HTML doc*/
    }
</script>

<script>
    var colors = d3.scale.category20();
    var chart;

    // initialise
    var filter = "continent";
    var mode = "percent";
    filterData("generate");

    function modeChange(modeC){
        mode = modeC;
        filterData("update");
    }

    function filterChange(filterC) {
        filter = filterC;
        filterData("update");
    }


    function update(selectedData){

            d3.select('#chart1')
                .datum(selectedData)
                .transition().duration(1000)
                .call(chart)
                .each('start', function () {
                    setTimeout(function () {
                        d3.selectAll('#chart1 *').each(function () {
                            if (this.__transition__)
                                this.__transition__.duration = 1;
                        })
                    }, 0)
                });
            nv.utils.windowResize(chart.update);
    }


    function generate(selectedData) {
        nv.addGraph(function () {
            chart = nv.models.stackedAreaChart()
                .useInteractiveGuideline(true)
                .x(function (d) {
                    return d[0]
                })
                .y(function (d) {
                    return d[1]
                })
                .controlLabels({stacked: "Stacked"})
                .duration(300);
            chart.yAxis.tickFormat(d3.format(',.1f'));
            chart.legend.vers('classic');
            d3.select('#chart1')
                .datum(selectedData)
                .transition().duration(1000)
                .call(chart)
                .each('start', function () {
                    setTimeout(function () {
                        d3.selectAll('#chart1 *').each(function () {
                            if (this.__transition__)
                                this.__transition__.duration = 1;
                        })
                    }, 0)
                });
            nv.utils.windowResize(chart.update);

            return chart;
        }); // End of addGraph
    } // End of Generate funtion




    function filterData(chooseNext) {
        var selectedData;

        d3.csv("/data/stacked-data.csv", function (data) {

            console.log(filter);

            if (filter == "continent") {
                var ByContinent = d3.nest()
                    .key(function (d) {
                        return d["Continent Name"];
                    })
                    .entries(data);

                // Sums data per year per continent
                ByContinent.forEach(function (d) {

                    // Index equals year ([0] = 2000, [1] = 2001 etc)
                    var sums = [0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0];

                    if(mode == "millions") {

                        for (var i = 0; i < d.values.length; i++) {
                            sums[0] += +d.values[i].m2000;
                            sums[1] += +d.values[i].m2001;
                            sums[2] += +d.values[i].m2002;
                            sums[3] += +d.values[i].m2003;
                            sums[4] += +d.values[i].m2004;
                            sums[5] += +d.values[i].m2005;
                            sums[6] += +d.values[i].m2006;
                            sums[7] += +d.values[i].m2007;
                            sums[8] += +d.values[i].m2008;
                            sums[9] += +d.values[i].m2009;
                            sums[10] += +d.values[i].m2010;
                            sums[11] += +d.values[i].m2011;
                            sums[12] += +d.values[i].m2012;
                            sums[13] += +d.values[i].m2013;
                            sums[14] += +d.values[i].m2014;
                            sums[15] += +d.values[i].m2015;
                        }
                    }else{ // percentage
                        for (var i = 0; i < d.values.length; i++) {
                            sums[0] += +d.values[i].p2000;
                            sums[1] += +d.values[i].p2001;
                            sums[2] += +d.values[i].p2002;
                            sums[3] += +d.values[i].p2003;
                            sums[4] += +d.values[i].p2004;
                            sums[5] += +d.values[i].p2005;
                            sums[6] += +d.values[i].p2006;
                            sums[7] += +d.values[i].p2007;
                            sums[8] += +d.values[i].p2008;
                            sums[9] += +d.values[i].p2009;
                            sums[10] += +d.values[i].p2010;
                            sums[11] += +d.values[i].p2011;
                            sums[12] += +d.values[i].p2012;
                            sums[13] += +d.values[i].p2013;
                            sums[14] += +d.values[i].p2014;
                            sums[15] += +d.values[i].p2015;
                        }
                    }

                    d.sums = sums;
                });

                // Allocates the sums to the years in 2d array of values
                ByContinent.forEach(function (d) {
                    d.values = [
                        [2000, d.sums[0]],
                        [2001, d.sums[1]],
                        [2002, d.sums[2]],
                        [2003, d.sums[3]],
                        [2004, d.sums[4]],
                        [2005, d.sums[5]],
                        [2006, d.sums[6]],
                        [2007, d.sums[7]],
                        [2008, d.sums[8]],
                        [2009, d.sums[9]],
                        [2010, d.sums[10]],
                        [2011, d.sums[11]],
                        [2012, d.sums[12]],
                        [2013, d.sums[13]],
                        [2014, d.sums[14]],
                        [2015, d.sums[15]]
                    ]
                });
                selectedData = ByContinent;
            } // End of ifContinent

            if (filter != "continent") {
                if (filter != "all") {
                    data = data.filter(function (d) {
                        return d["Continent Code"] == filter;
                    });
                }
                data.forEach(function (d) {
                    d.key = d.Country;

                    if(mode == "millions") {
                        d.values = [
                            [2000, +d.m2000],
                            [2001, +d.m2001],
                            [2002, +d.m2002],
                            [2003, +d.m2003],
                            [2004, +d.m2004],
                            [2005, +d.m2005],
                            [2006, +d.m2006],
                            [2007, +d.m2007],
                            [2008, +d.m2008],
                            [2009, +d.m2009],
                            [2010, +d.m2010],
                            [2011, +d.m2011],
                            [2012, +d.m2012],
                            [2013, +d.m2013],
                            [2014, +d.m2014],
                            [2015, +d.m2015]
                        ]
                    }else{ // percentage
                        d.values = [
                            [2000, +d.p2000],
                            [2001, +d.p2001],
                            [2002, +d.p2002],
                            [2003, +d.p2003],
                            [2004, +d.p2004],
                            [2005, +d.p2005],
                            [2006, +d.p2006],
                            [2007, +d.p2007],
                            [2008, +d.p2008],
                            [2009, +d.p2009],
                            [2010, +d.p2010],
                            [2011, +d.p2011],
                            [2012, +d.p2012],
                            [2013, +d.p2013],
                            [2014, +d.p2014],
                            [2015, +d.p2015]
                        ]
                    }
                });
                selectedData = data;

            } // End of ifCountry

            if(chooseNext == "generate"){
                generate(selectedData)
            }else{
                update(selectedData)
            }

        }); // End of file loop
    }


</script>
</body>
</html>